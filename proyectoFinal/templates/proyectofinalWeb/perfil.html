{% extends  "proyectofinalWeb/_privado/base.html" %}

{% load static %}

{% block title %} Inicio {% endblock %}
{% block estilos %}
    <style>
        .edit-btn {
            display: none;
        }

        .editable-row:hover .edit-btn {
            display: inline-block;
        }
    </style>
{% endblock %}
{% block despUsuario %}
    <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown">
            <div id="userDropdown" class="d-flex flex-row" data-bs-toggle="dropdown" role="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class=" my-auto bi bi-person-circle" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                    <path fill-rule="evenodd"
                          d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                </svg>
                <a class="nav-link dropdown-toggle" href="#" aria-expanded="false">
                    {{ nombre }}
                </a>
            </div>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" href="#">Perfil</a></li>
                <li><a class="dropdown-item" href="{% url 'misRutas' %}">Mis Rutas</a></li>
                {% if admin %}
                    <li><a class="dropdown-item" href={% url 'administracion' %}>Configuración</a></li>
                {% endif %}

                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <form action="{% url 'index' %}" method="post">
                        {% csrf_token %}
                        <input class="dropdown-item" type="submit" value="Cerrar Sesion">
                    </form>
                </li>
            </ul>
        </li>
    </ul>
{% endblock %}
{% block contenido %}
    {% for c in caract %}
        <div class="container mt-4 mb-4">
            <div class="text-center">
                <h3>Nombre de usuario</h3>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col text-center">
                        <div class=" mx-auto w-25">
                            <p class="mb-0">Tienes</p>
                            <h1 class="mb-0">{{ rutas.count }} </h1> {% if rutas.count > 0  and rutas.count > 1 %}
                            <span>Rutas</span> {% elif rutas.count == 1 %}<span>Ruta</span>{% endif %}
                        </div>
                    </div>
                </div>
                <div class="container w-50">
                    <div class="row border-top text-center align-items-center py-2 editable-row" id="id_nomUsu">
                        <div class="col text-sm-end align-bottom">
                            <p class="m-0 my-2 tipo">Nombre de usuario:</p>
                        </div>
                        <div class="col text-sm-start my-auto d-flex justify-content-between align-items-center editable-container">
                            <p class="m-0 my-2 editable-text">{{ c.usuario_id.username }}</p>
                            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn ms-2"
                                    onclick="startEdit('id_nomUsu')">
                                ✏️
                            </button>
                        </div>
                    </div>
                    <div class="row border-top border-bottom text-center align-items-center py-2 editable-row"
                         id="id_fecha">
                        <div class="col text-sm-end ">
                            <p class="m-0 my-2 tipo">Fecha de nacimiento:</p>
                        </div>
                        <div class="col text-sm-start my-auto d-flex justify-content-between align-items-center editable-container">
                            <p class="m-0 my-2">{{ c.fechaNacimiento }}</p>
                            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn ms-2"
                                    onclick="startEdit('id_fecha')">
                                ✏️
                            </button>
                        </div>
                    </div>
                    <div class="row border-top border-bottom text-center align-items-center py-2 editable-row"
                         id="id_peso">
                        <div class="col text-sm-end my-auto">
                            <p class="m-0 my-2 tipo">Peso:</p>
                        </div>
                        <div class="col text-sm-start my-auto px-0 d-flex justify-content-between align-items-center editable-container">
                            <p class="m-0 my-2 editable-text">{{ c.peso }} Kg</p>
                            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn ms-2"
                                    onclick="startEdit('id_peso')">
                                ✏️
                            </button>
                        </div>
                    </div>
                    <div class="row border-top border-bottom text-center align-items-center py-2 editable-row"
                         id="id_forma">
                        <div class="col text-sm-end">
                            <p class="m-0 my-2 tipo">Forma física:</p>
                        </div>
                        <div class="col text-sm-start my-auto d-flex justify-content-between align-items-center editable-container">
                            <p class="m-0 my-2 ">Principiante</p>
                            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn ms-2"
                                    onclick="startEdit('id_forma')">
                                ✏️
                            </button>
                        </div>
                    </div>
                    <div class="row border-top border-bottom text-center align-items-center py-2 editable-row"
                         id="id_terreno">
                        <div class="col text-sm-end">
                            <p class="m-0 my-2 tipo">Terreno preferido:</p>
                        </div>
                        <div class="col text-sm-start my-auto d-flex justify-content-between align-items-center editable-container">
                            <p class="m-0 my-2 editable-text">Asfalto</p>
                            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn ms-2"
                                    onclick="startEdit('id_terreno')">
                                ✏️
                            </button>
                        </div>
                    </div>
                    <div class="row border-top border-bottom text-center align-items-center py-2 editable-row"
                         id="id_tipoBici">
                        <div class="col text-sm-end">
                            <p class="m-0 my-2 tipo">Tipo de bicicleta preferida:</p>
                        </div>
                        <div class="col text-sm-start my-auto d-flex justify-content-between align-items-center editable-container">
                            <p class="m-0 my-2 editable-text">Carretera</p>
                            <button type="button" class="btn btn-outline-secondary btn-sm edit-btn ms-2"
                                    onclick="startEdit('id_tipoBici')">
                                ✏️
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    <script>
        function startEdit(rowId) {
            const row = document.getElementById(rowId);
            const container = row.querySelector('.editable-container');
            const textElement = container.querySelector('.editable-text');
            const editBtn = container.querySelector('.edit-btn');
            let tipoInp = row.querySelector('.tipo');
            let currentValue = textElement.textContent.trim();

            editBtn.style.display = 'none';

            let input = null;
            if (tipoInp.innerHTML.startsWith("Tipo")) {
                currentValue = currentValue.split(" ")[0];
                input = document.createElement('select');
                input.className = 'form-control form-control-sm me-2';

                const opcionesTipo = ["Carretera", "Gravel"];

                opcionesTipo.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    if (option === currentValue) {
                        optionElement.selected = true;
                    }
                    input.appendChild(optionElement);
                });

            } else if (tipoInp.innerHTML.startsWith("Terreno")) {

                currentValue = currentValue.split(" ")[0];
                input = document.createElement('select');
                input.className = 'form-control form-control-sm me-2';

                const opcionesTerreno = ["Asfalto", "Pista"];

                opcionesTerreno.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;

                    if (option === currentValue) {
                        optionElement.selected = true;
                    }
                    input.appendChild(optionElement);
                });
            } else if (tipoInp.innerHTML.startsWith("Peso")) {
                currentValue = currentValue.split(" ")[0];
                input = document.createElement('input');
                input.type = 'number';
                input.className = 'form-control form-control-sm me-2';
                input.placeholder = currentValue;
                input.value = currentValue;
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control form-control-sm me-2';
                input.placeholder = currentValue;
                input.value = currentValue;
            }
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success btn-sm me-2';
            saveBtn.innerHTML = '✔';
            saveBtn.onclick = () => {
                const newValue = input.value.trim() || currentValue;

                if (rowId === 'id_terreno') {
                    const tipoBiciRow = document.getElementById('id_tipoBici');
                    const tipoBici = tipoBiciRow.querySelector('.editable-text').textContent.trim();

                    if (tipoBici === 'Carretera' && newValue === 'Pista') {
                        alert(`No se puede usar bicicleta de tipo "${tipoBici}" en terreno "${newValue}".`);
                        return;
                    }
                }

                const newP = document.createElement('p');
                newP.className = 'm-0 my-2 editable-text';
                newP.textContent = newValue;

                container.querySelector('.edit-actions').remove();
                input.remove();
                container.insertBefore(newP, editBtn);
                editBtn.style.display = 'inline-block';

/////PUEDE NO FUNCIONAR///////
                fetch('{% url 'actualizar_usuario' %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')  // ← función para CSRF token
                    },
                    body: JSON.stringify({
                        rowId: rowId,
                        value: newValue
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            const newP = document.createElement('p');
                            newP.className = 'm-0 my-2 editable-text';
                            newP.textContent = newValue;

                            container.querySelector('.edit-actions').remove();
                            input.remove();
                            container.insertBefore(newP, editBtn);
                            editBtn.style.display = 'inline-block';
                        } else {
                            alert("Error al guardar los datos en el servidor.");
                        }
                    });
///////PUEDE NO FUNCIONAR/////////

            };
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-danger btn-sm';
            cancelBtn.innerHTML = '✖';
            cancelBtn.onclick = () => {
                container.querySelector('.edit-actions').remove();
                input.remove();
                container.insertBefore(textElement, editBtn);
                editBtn.style.display = 'inline-block';
            };

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'edit-actions d-flex';
            actionsDiv.appendChild(saveBtn);
            actionsDiv.appendChild(cancelBtn);

            textElement.remove();

            container.insertBefore(input, editBtn);
            container.insertBefore(actionsDiv, editBtn);
        }

        const rows = document.querySelectorAll('.editable-row');
        rows.forEach(row => {
            const editBtn = row.querySelector('.edit-btn');

            row.addEventListener('mouseenter', () => {
                if (!row.querySelector('input') && !row.querySelector('select')) {
                    editBtn.style.display = 'inline-block';
                }
            });
            row.addEventListener('mouseleave', () => {
                if (!row.querySelector('input') && !row.querySelector('select')) {
                    editBtn.style.display = 'none';
                }
            });
        });

        ///////PUEDE NO FUNCIONAR/////////
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        ///////PUEDE NO FUNCIONAR/////////
    </script>
{% endblock %}
{% block js %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}